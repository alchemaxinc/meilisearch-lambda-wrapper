name: Automatic Version Synchronization

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Daily at midnight

permissions:
  contents: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.14"

jobs:
  get-current-local-meilisearch-docker-version:
    runs-on: ubuntu-latest
    outputs:
      local_version: ${{ steps.get-local-version.outputs.local_version }}

    steps:
      - &checkout-code
        name: Checkout code (shallow)
        uses: actions/checkout@v5

      - name: Get current local Meilisearch Docker version
        id: get-local-version
        run: |
          LOCAL_VERSION=$(sed -nE 's/^FROM[[:space:]]+getmeili\/meilisearch:([^[:space:]]+).*/\1/p' Dockerfile)
          if [ -z "$LOCAL_VERSION" ]; then
            echo "Failed to extract Meilisearch image tag from Dockerfile." >&2
            exit 1
          fi

          echo "local_version=$LOCAL_VERSION" >> "$GITHUB_OUTPUT"

          echo "::notice::Current local Meilisearch Docker version: $LOCAL_VERSION"
          echo "## ðŸ³ Current Local Meilisearch Version" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$LOCAL_VERSION\`" >> $GITHUB_STEP_SUMMARY

  get-newest-meiliseach-docker-version:
    runs-on: ubuntu-latest
    outputs:
      latest_version: ${{ steps.get-latest-version.outputs.latest_version }}

    steps:
      - *checkout-code

      - &setup-python
        name: Setup Python
        uses: actions/setup-python@v6
        with:
          cache: "pip"
          python-version: "${{ env.PYTHON_VERSION }}"
          cache-dependency-path: infrastructure/sync_versions/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Get latest version of Meilisearch Docker image
        id: get-latest-version
        working-directory: infrastructure/sync_versions
        run: |
          LATEST_VERSION=$(python cli.py get-latest-meilisearch-version)
          if [ -z "$LATEST_VERSION" ]; then
            echo "Failed to extract latest Meilisearch Docker version from Docker Hub" >&2
            exit 1
          fi

          echo "latest_version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"

          echo "::notice::Latest Meilisearch Docker version available: $LATEST_VERSION"
          echo "## ðŸš€ Latest Meilisearch Version" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$LATEST_VERSION\`" >> $GITHUB_STEP_SUMMARY

  update-and-sync-meilisearch-version:
    runs-on: ubuntu-latest
    env:
      LOCAL_VERSION: ${{ needs.get-current-local-meilisearch-docker-version.outputs.local_version }}
      LATEST_VERSION: ${{ needs.get-newest-meiliseach-docker-version.outputs.latest_version }}
    needs:
      - get-newest-meiliseach-docker-version
      - get-current-local-meilisearch-docker-version

    steps:
      - name: Create temporary GitHub App Token
        id: app
        uses: actions/create-github-app-token@v1
        with:
          owner: ${{ github.repository_owner }}
          app-id: ${{ vars.HOUSEKEEPING_BOT_APP_ID }}
          private-key: ${{ secrets.HOUSEKEEPING_BOT_PRIVATE_KEY }}

      - name: Checkout and setup
        uses: alchemaxinc/composite-toolbox/checkout-and-setup@v1
        with:
          token: ${{ steps.app.outputs.token }}

      - *setup-python

      - name: Print and verify versions
        id: print-versions

        run: |
          echo "Local version: $LOCAL_VERSION"
          echo "Latest version: $LATEST_VERSION"

          if [ -z "$LOCAL_VERSION" ] || [ -z "$LATEST_VERSION" ]; then
            echo "Error: LOCAL_VERSION or LATEST_VERSION is empty" >&2
            exit 1
          fi

      - name: Update local Meilisearch Docker version
        id: update-version
        run: sed -i "s/FROM getmeili\/meilisearch:${LOCAL_VERSION}/FROM getmeili\/meilisearch:${LATEST_VERSION}/g" Dockerfile

      - name: Check for changes
        id: check_changes
        uses: alchemaxinc/composite-toolbox/check-changes@v1
        with:
          files: "Dockerfile"

      - name: Create Pull Request
        id: open-pr
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: alchemaxinc/composite-toolbox/create-pr@v1
        with:
          token: ${{ steps.app.outputs.token }}
          base-branch: "main"
          branch-prefix: "fix/auto/meilisearch-docker-version"
          files: "Dockerfile"
          commit-message: "fix: update Meilisearch Docker version to ${{ needs.get-newest-meiliseach-docker-version.outputs.latest_version }}"
          pr-title: "fix: automatic Mielisearch Docker version upgrade"
          pr-body: |
            This PR updates the Meilisearch Docker version in the Dockerfile to the latest available version.

            - Previous version: `${{ needs.get-current-local-meilisearch-docker-version.outputs.local_version }}`
            - New version: `${{ needs.get-newest-meiliseach-docker-version.outputs.latest_version }}`

      - name: Auto-merge Pull Request
        if: steps.open-pr.outcome == 'success'
        uses: alchemaxinc/composite-toolbox/merge-pr@v1
        with:
          token: ${{ inputs.token }}
          merge-method: "merge"
          pull-request-number: ${{ steps.open-pr.outputs.pr_number }}
